<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrôle du Robot Tondeuse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .speed-bar { background-color: #e2e8f0; border-radius: 9999px; height: 1rem; width: 100%; overflow: hidden; }
        .speed-fill { height: 100%; background-color: #4f46e5; transition: width 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 flex justify-center items-center min-h-screen">

    <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 md:p-10 w-full max-w-lg space-y-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">Contrôle du Robot</h1>
        
        <div class="flex justify-between items-center bg-gray-50 p-4 rounded-xl shadow-inner">
            <div class="text-center"><span id="speed-display" class="block text-2xl font-bold text-indigo-600">3.0</span><span class="text-sm text-gray-500">km/h</span></div>
            <div class="text-center"><span id="angle-display" class="block text-2xl font-bold text-indigo-600">90</span><span class="text-sm text-gray-500">degrés</span></div>
            <div class="text-center"><span id="diameter-display" class="block text-2xl font-bold text-indigo-600">150</span><span class="text-sm text-gray-500">cm</span></div>
            <div class="text-center"><span id="status-display" class="block text-sm font-semibold text-green-500">Prêt</span><span class="text-sm text-gray-500">Statut</span></div>
        </div>

        <div class="grid grid-cols-3 gap-4">
            <div></div><button id="forward-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-105"><svg class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg></button><div></div>
            <button id="left-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-105"><svg class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
            <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-full shadow-lg transition transform hover:scale-105 font-bold">STOP</button>
            <button id="right-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-105"><svg class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg></button>
            <div></div><button id="backward-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-105"><svg class="h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg></button><div></div>
        </div>
        
        <div class="space-y-6">
             <div class="flex items-center space-x-4"><span class="text-lg font-semibold w-20">Vitesse</span><button id="speed-minus-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition">-</button><div class="w-full speed-bar"><div id="speed-fill" class="speed-fill" style="width: 30%;"></div></div><button id="speed-plus-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition">+</button></div>
            <div class="flex items-center space-x-4"><span class="text-lg font-semibold w-20">Angle</span><button id="angle-minus-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition">-</button><div class="w-full h-2 bg-gray-300 rounded-full overflow-hidden"><div id="angle-bar" class="bg-indigo-600 h-full" style="width: 50%;"></div></div><button id="angle-plus-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition">+</button></div>
            <div class="flex items-center space-x-4"><span class="text-lg font-semibold w-20">Diamètre</span><button id="diameter-minus-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition">-</button><div class="w-full h-2 bg-gray-300 rounded-full overflow-hidden"><div id="diameter-bar" class="bg-indigo-600 h-full" style="width: 50%;"></div></div><button id="diameter-plus-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition">+</button></div>
        </div>

        <div class="flex justify-around items-center space-x-4 pt-4">
            <button id="start-record-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition">Démarrer Enregistrement</button>
        </div>
        <div class="flex justify-around items-center space-x-4 pt-4">
            <button id="stop-record-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition">Arrêt Enregistrement</button>
        </div>
        <div class="flex justify-around items-center space-x-4">
            <button id="obstacle-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition">Simuler Obstacle</button>
            <button id="resume-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition" style="display: none;">Reprendre</button>
        </div>
        <div class="mt-2 text-center">
            <a href="/zones" class="w-full inline-block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition">Voir les Zones</a>
        </div>
    </div>
    
    <div id="record-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg text-center">
            <h2 class="text-2xl font-bold mb-4 text-indigo-700">Enregistrement en cours...</h2>
            <canvas id="live-canvas" class="w-full aspect-square bg-gray-100 rounded-lg shadow-inner"></canvas>
            <button id="modal-stop-record-btn" class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg">Terminer et Sauvegarder</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = '/api/command';
        const statusDisplay = document.getElementById('status-display'), speedDisplay = document.getElementById('speed-display'), angleDisplay = document.getElementById('angle-display'), diameterDisplay = document.getElementById('diameter-display');
        const speedFill = document.getElementById('speed-fill'), angleBar = document.getElementById('angle-bar'), diameterBar = document.getElementById('diameter-bar');
        const speedPlusBtn = document.getElementById('speed-plus-btn'), speedMinusBtn = document.getElementById('speed-minus-btn');
        const anglePlusBtn = document.getElementById('angle-plus-btn'), angleMinusBtn = document.getElementById('angle-minus-btn');
        const diameterPlusBtn = document.getElementById('diameter-plus-btn'), diameterMinusBtn = document.getElementById('diameter-minus-btn');
        const startRecordBtn = document.getElementById('start-record-btn'), obstacleBtn = document.getElementById('obstacle-btn'), resumeBtn = document.getElementById('resume-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const modal = document.getElementById('record-modal'), modalStopBtn = document.getElementById('modal-stop-record-btn'), liveCanvas = document.getElementById('live-canvas');
        const ctx = liveCanvas.getContext('2d');
        
        let currentSpeed = 3.0, currentAngle = 90.0, currentDiameter = 150.0;
        let lastStatusMessage = "", pollingInterval = null;

        const MAX_SPEED = 10.0, MIN_SPEED = 0.5, SPEED_STEP = 0.5;
        const MAX_ANGLE = 360.0, MIN_ANGLE = 5.0, ANGLE_STEP = 5.0;
        const MAX_DIAMETER = 300.0, MIN_DIAMETER = 0.0, DIAMETER_STEP = 10.0;

        function updateUI() {
            speedDisplay.textContent = currentSpeed.toFixed(1); angleDisplay.textContent = currentAngle.toFixed(0); diameterDisplay.textContent = currentDiameter.toFixed(0);
            speedFill.style.width = `${((currentSpeed - MIN_SPEED) / (MAX_SPEED - MIN_SPEED)) * 100}%`; angleBar.style.width = `${((currentAngle - MIN_ANGLE) / (MAX_ANGLE - MIN_ANGLE)) * 100}%`; diameterBar.style.width = `${(currentDiameter / MAX_DIAMETER) * 100}%`;
        }

        async function sendCommand(command, params = {}) {
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ command, params }) });
                const data = await response.json();
                if (data.message) { lastStatusMessage = data.message; updateStatusDisplay(data.message, response.ok ? 'success' : 'error'); }
            } catch (error) { lastStatusMessage = 'Erreur réseau'; updateStatusDisplay(lastStatusMessage, 'error'); }
        }

        function updateStatusDisplay(message, type = 'info') {
            statusDisplay.textContent = message; statusDisplay.className = '';
            const typeClasses = { success: 'text-green-500', error: 'text-red-500', info: 'text-gray-500', busy: 'text-blue-500', warning: 'text-yellow-600' };
            statusDisplay.classList.add('block', 'text-sm', 'font-semibold', typeClasses[type]);
            if (message && message.toLowerCase().includes('pause')) { obstacleBtn.style.display = 'none'; resumeBtn.style.display = 'block'; } 
            else { obstacleBtn.style.display = 'block'; resumeBtn.style.display = 'none'; }
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) return;
                const data = await response.json();
                currentSpeed = data.speed; currentAngle = data.angle; currentDiameter = data.diameter;
                updateUI();
                if (data.status !== lastStatusMessage) {
                    let statusType = 'info';
                    if (data.status === "Prêt") statusType = 'success';
                    else if (data.status.toLowerCase().includes('pause')) statusType = 'warning';
                    else if (data.status !== "Prêt") statusType = 'busy';
                    updateStatusDisplay(data.status, statusType);
                }
            } catch (error) { updateStatusDisplay("Déconnecté", "error"); }
        }

        function drawLivePath(vectors) {
            liveCanvas.width = liveCanvas.clientWidth; liveCanvas.height = liveCanvas.clientHeight;
            ctx.clearRect(0, 0, liveCanvas.width, liveCanvas.height);
            if (!vectors || vectors.length === 0) return;
            ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            let minX = 0, maxX = 0, minY = 0, maxY = 0, x = 0, y = 0, angle = -90;
            const pathPoints = [{x: 0, y: 0}];
            vectors.forEach(v => {
                angle += v.relative_angle; const angleRad = angle * Math.PI / 180;
                x += v.distance * Math.cos(angleRad); y += v.distance * Math.sin(angleRad);
                pathPoints.push({x: x, y: y});
                minX = Math.min(minX, x); maxX = Math.max(maxX, x); minY = Math.min(minY, y); maxY = Math.max(maxY, y);
            });
            const pathWidth = maxX - minX, pathHeight = maxY - minY;
            if (pathWidth === 0 && pathHeight === 0) return;
            const scale = Math.min((liveCanvas.width * 0.9) / (pathWidth || 1), (liveCanvas.height * 0.9) / (pathHeight || 1));
            const startX = (liveCanvas.width / 2) - ((minX + maxX) / 2 * scale);
            const startY = (liveCanvas.height / 2) - ((minY + maxY) / 2 * scale);
            ctx.beginPath(); ctx.moveTo(startX, startY);
            pathPoints.slice(1).forEach(p => { ctx.lineTo(startX + p.x * scale, startY + p.y * scale); });
            ctx.stroke();
            ctx.beginPath(); ctx.arc(startX, startY, 6, 0, 2 * Math.PI); ctx.fillStyle = '#10b981'; ctx.fill();
            ctx.beginPath(); ctx.arc(startX + x * scale, startY + y * scale, 6, 0, 2 * Math.PI); ctx.fillStyle = '#ef4444'; ctx.fill();
        }

        async function pollLivePath() {
            try {
                const response = await fetch('/api/live_path');
                const vectors = await response.json();
                drawLivePath(vectors);
            } catch (error) { console.error("Erreur de polling:", error); }
        }

        async function stopAndSaveRecording() {
            clearInterval(pollingInterval); pollingInterval = null;
            modal.style.display = 'none';
            let existingZonesText = 'Noms déjà utilisés :';
            try {
                const response = await fetch('/api/zones');
                const zones = await response.json();
                if (zones.length > 0) { existingZonesText += '\n- ' + zones.map(z => z.name).join('\n- '); } 
                else { existingZonesText = 'Aucune zone enregistrée.'; }
            } catch (e) { existingZonesText = "Attention : impossible de vérifier les noms."; }
            const zoneName = prompt(`Entrez un nom pour cette zone :\n\n${existingZonesText}`);
            if (zoneName && zoneName.trim() !== "") { sendCommand('stop_recording', { zone_name: zoneName.trim() }); }
        }

        const continuousCommands = {'forward-btn':'forward', 'backward-btn':'backward', 'left-btn':'turn_left', 'right-btn':'turn_right'};
        for (const [btnId, cmd] of Object.entries(continuousCommands)) {
            const btn = document.getElementById(btnId);
            btn.addEventListener('mousedown', () => sendCommand(cmd));
            //btn.addEventListener('mouseup', () => sendCommand('stop'));
            //btn.addEventListener('mouseleave', () => sendCommand('stop'));
        }
        document.getElementById('stop-btn').addEventListener('click', () => {
            if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; modal.style.display = 'none'; }
            sendCommand('stop');
        });
        speedPlusBtn.addEventListener('click', () => { currentSpeed = Math.min(MAX_SPEED, currentSpeed + SPEED_STEP); updateUI(); sendCommand('set_speed', { speed: currentSpeed }); });
        speedMinusBtn.addEventListener('click', () => { currentSpeed = Math.max(MIN_SPEED, currentSpeed - SPEED_STEP); updateUI(); sendCommand('set_speed', { speed: currentSpeed }); });
        anglePlusBtn.addEventListener('click', () => { currentAngle = Math.min(MAX_ANGLE, currentAngle + ANGLE_STEP); updateUI(); sendCommand('set_angle', { angle: currentAngle }); });
        angleMinusBtn.addEventListener('click', () => { currentAngle = Math.max(MIN_ANGLE, currentAngle - ANGLE_STEP); updateUI(); sendCommand('set_angle', { angle: currentAngle }); });
        diameterPlusBtn.addEventListener('click', () => { currentDiameter = Math.min(MAX_DIAMETER, currentDiameter + DIAMETER_STEP); updateUI(); sendCommand('set_diameter', { diameter: currentDiameter }); });
        diameterMinusBtn.addEventListener('click', () => { currentDiameter = Math.max(MIN_DIAMETER, currentDiameter - DIAMETER_STEP); updateUI(); sendCommand('set_diameter', { diameter: currentDiameter }); });
        
        startRecordBtn.addEventListener('click', () => { sendCommand('start_recording'); modal.style.display = 'none'; pollingInterval = setInterval(pollLivePath, 2000); });
        //stopRecordBtn.addEventListener('click', () => { sendCommand('stop_recording');
        //modalStopBtn.addEventListener('click', stopAndSaveRecording);
        stopRecordBtn.addEventListener('click', stopAndSaveRecording);
        obstacleBtn.addEventListener('click', () => sendCommand('simulate_obstacle'));
        resumeBtn.addEventListener('click', () => sendCommand('resume'));

        updateUI();
        setInterval(fetchStatus, 2500);
    });
    </script>
</body>
</html>