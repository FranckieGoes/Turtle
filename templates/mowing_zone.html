<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation de la Zone de Tonte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;800;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #1f2937;
        }
        canvas {
            background-color: #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            touch-action: none; /* Emp√™che le d√©filement de la page lors d'un pinch-to-zoom */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-2xl text-center flex flex-col items-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-indigo-700">Visualisation de la Zone</h1>
        <p class="text-gray-600 mb-6">Trac√© du dernier parcours enregistr√© du robot.</p>

        <!-- Conteneur pour le canvas, la zone de zoom, et le message d'√©tat -->
        <div class="relative w-full h-96">
            <canvas id="mowingZoneCanvas" class="w-full h-full"></canvas>
            
            <!-- Contr√¥les de zoom -->
            <div class="absolute bottom-4 right-4 flex space-x-2">
                <button id="zoomInBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <button id="zoomOutBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </button>
            </div>

            <!-- Message d'√©tat du zoom -->
            <div id="zoomStatus" class="absolute bottom-4 left-4 bg-gray-800 text-white text-xs px-2 py-1 rounded-full shadow-md">
                Zoom: 100%
            </div>
            <div class="mt-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <button onclick="fetchAndDrawPath()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-full transition-colors duration-200">
                <span class="mr-2">üîÑ</span> Recharger le trac√©
            </button>
            <a href="/" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-full transition-colors duration-200">
                <span class="mr-2">üè†</span> Retour au contr√¥le
            </a>
        </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('mowingZoneCanvas');
            const ctx = canvas.getContext('2d');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const zoomStatus = document.getElementById('zoomStatus');

            // Donn√©es de test pour le trac√©
            const vectors = [
                { "distance": 100, "relative_angle": 0 },
                { "distance": 150, "relative_angle": 90 },
                { "distance": 120, "relative_angle": -45 },
                { "distance": 180, "relative_angle": 90 },
                { "distance": 200, "relative_angle": -135 },
                { "distance": 100, "relative_angle": 0 },
                { "distance": 150, "relative_angle": 90 },
                { "distance": 120, "relative_angle": -45 },
                { "distance": 180, "relative_angle": 90 },
                { "distance": 200, "relative_angle": -135 }
            ];

            let scale = 1.0;
            let originX = 0;
            let originY = 0;

            const MIN_SCALE = 0.5;
            const MAX_SCALE = 4.0;
            const ZOOM_STEP = 0.2;

            // Fonction pour dessiner le trac√©
            const drawTrace = () => {
                // Ajuster la taille du canvas
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;

                // Effacer le canvas et appliquer la transformation de zoom
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2 + originX, canvas.height / 2 + originY);
                ctx.scale(scale, scale);
                ctx.translate(-(canvas.width / 2), -(canvas.height / 2));
                
                // Dessiner le trac√©
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                let currentX = canvas.width / 2;
                let currentY = canvas.height / 2;
                let currentAngle = -90; // Le "haut" du canvas, en degr√©s
                
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);

                vectors.forEach(vector => {
                    const distance = vector.distance;
                    const relativeAngle = vector.relative_angle;
                    
                    currentAngle += relativeAngle;
                    const angleRad = (currentAngle + 90) * Math.PI / 180;

                    const newX = currentX + distance * Math.cos(angleRad);
                    const newY = currentY + distance * Math.sin(angleRad);
                    
                    ctx.lineTo(newX, newY);
                    currentX = newX;
                    currentY = newY;
                });
                
                ctx.stroke();

                // Dessiner le point de d√©part
                ctx.beginPath();
                ctx.arc(canvas.width / 2, canvas.height / 2, 8, 0, 2 * Math.PI);
                ctx.fillStyle = '#10b981';
                ctx.fill();

                // Dessiner le point d'arriv√©e
                ctx.beginPath();
                ctx.arc(currentX, currentY, 8, 0, 2 * Math.PI);
                ctx.fillStyle = '#ef4444';
                ctx.fill();

                // Restaurer l'√©tat du canvas
                ctx.restore();
            };

            // Fonction pour mettre √† jour le niveau de zoom
            const updateZoom = (newScale) => {
                scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
                drawTrace();
                zoomStatus.textContent = `Zoom: ${Math.round(scale * 100)}%`;
            };

            // √âv√©nements de zoom
            zoomInBtn.addEventListener('click', () => updateZoom(scale + ZOOM_STEP));
            zoomOutBtn.addEventListener('click', () => updateZoom(scale - ZOOM_STEP));

            // Zoom avec la molette de la souris
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const newScale = e.deltaY > 0 ? scale - ZOOM_STEP : scale + ZOOM_STEP;
                updateZoom(newScale);
            });

            // G√©rer le redimensionnement de la fen√™tre
            window.addEventListener('resize', () => {
                drawTrace();
            });

            // Pan avec la souris
            let isDragging = false;
            let lastX = 0;
            let lastY = 0;

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastX;
                    const deltaY = e.clientY - lastY;
                    originX += deltaX;
                    originY += deltaY;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    drawTrace();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // G√©rer le pan sur les appareils tactiles
            let lastTouchX = 0;
            let lastTouchY = 0;

            canvas.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    originX += deltaX;
                    originY += deltaY;
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                    drawTrace();
                }
            }, { passive: false });

            canvas.addEventListener('touchend', () => {
                isDragging = false;
            });
            
            // Lancement initial du dessin
            drawTrace();
        });
    </script>
</body>
</html>
